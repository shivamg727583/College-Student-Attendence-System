<!-- views/mark-attendance.ejs -->
<%- include('partials/header', { title: 'Mark Attendance', user: user }) %>

<div class="max-w-4xl mx-auto bg-white p-8 border border-gray-200 rounded shadow">
    <h2 class="text-2xl font-bold mb-6 text-blue-600">Mark Attendance</h2>

    <!-- Attendance Form -->
    <form action="/api/teachers/mark-attendance" method="POST"> <!-- Ensure this matches your backend route -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <!-- Select Class -->
            <div>
                <label for="class" class="block text-gray-700">Class:</label>
                <select id="class" name="class_name" required
                    class="w-full px-3 py-2 border rounded focus:outline-none focus:ring focus:border-blue-300">
                    <option value="">Select Class</option> <!-- Empty value for placeholder -->
                    <% 
                        // Create a Set to store unique class names
                        const uniqueClasses = new Set();
                        classes.forEach(classItem => {
                            if (!uniqueClasses.has(classItem.class_name)) {
                                uniqueClasses.add(classItem.class_name);
                    %>
                        <option value="<%= classItem.class_name %>" <%= selectedClass === classItem.class_name ? 'selected' : '' %>>
                            <%= classItem.class_name %>
                        </option>
                    <% 
                            }
                        });
                    %>
                </select>
            </div>

            <!-- Select Subject -->
            <div>
                <label for="subject" class="block text-gray-700">Subject:</label>
                <select id="subject" name="subjectId" required
                    class="w-full px-3 py-2 border rounded focus:outline-none focus:ring focus:border-blue-300">
                    <option value="">Select Subject</option> <!-- Empty value for placeholder -->
                    <% 
                        // Create a Set to store unique subjects
                        const uniqueSubjects = new Set();
                        subjects.forEach(subject => {
                            if (!uniqueSubjects.has(subject.subject_name)) {
                                uniqueSubjects.add(subject.subject_name);
                    %>
                        <option value="<%= subject._id %>" <%= selectedSubject === subject.subject_name ? 'selected' : '' %>>
                            <%= subject.subject_name %>
                        </option>
                    <% 
                            }
                        });
                    %>
                </select>
            </div>

            <!-- Select Semester -->
            <div>
                <label for="semester" class="block text-gray-700">Semester:</label>
                <select id="semester" name="semester" required
                    class="w-full px-3 py-2 border rounded focus:outline-none focus:ring focus:border-blue-300">
                    <option value="">Select Semester</option> <!-- Empty value for placeholder -->
                    <% 
                        // Create a Set to store unique semesters
                        const uniqueSemesters = new Set();
                        classes.forEach(classItem => {
                            if (!uniqueSemesters.has(classItem.semester)) {
                                uniqueSemesters.add(classItem.semester);
                    %>
                        <option value="<%= classItem.semester %>" <%= selectedSemester === classItem.semester ? 'selected' : '' %>>
                            Semester <%= classItem.semester %>
                        </option>
                    <% 
                            }
                        });
                    %>
                </select>
            </div>

            <!-- Select Branch -->
            <div>
                <label for="branch" class="block text-gray-700">Branch:</label>
                <select id="branch" name="branch" 
                    class="w-full px-3 py-2 border rounded focus:outline-none focus:ring focus:border-blue-300">
                    <option value="">Select Branch</option> <!-- Empty value for placeholder -->
                    <% 
                        // Define unique branches manually or from data if dynamic
                        const branches = ["Computer Science", "Electrical Engineering", "Mechanical Engineering", "Civil Engineering"];
                        branches.forEach(branch => { 
                    %>
                        <option value="<%= branch %>" <%= selectedBranch === branch ? 'selected' : '' %>>
                            <%= branch %>
                        </option>
                    <% }) %>
                    <!-- Add more branches as needed -->
                </select>
            </div>

            <!-- Select Section -->
            <div>
                <label for="section" class="block text-gray-700">Section:</label>
                <select id="section" name="section" required
                    class="w-full px-3 py-2 border rounded focus:outline-none focus:ring focus:border-blue-300">
                    <option value="">Select Section</option> <!-- Empty value for placeholder -->
                    <% 
                        // Create a Set to store unique sections
                        const uniqueSections = new Set();
                        classes.forEach(classItem => {
                            if (!uniqueSections.has(classItem.section)) {
                                uniqueSections.add(classItem.section);
                    %>
                        <option value="<%= classItem.section %>" <%= selectedSection === classItem.section ? 'selected' : '' %>>
                            Section <%= classItem.section %>
                        </option>
                    <% 
                            }
                        });
                    %>
                    <!-- Add more sections as needed -->
                </select>
            </div>
        </div>
        <button type="submit"
            class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition duration-200">Load Students</button>
    </form>

    <% if (students && students.length > 0) { %>
        <form action="/api/teachers/submit-attendance" method="POST" class="mt-8">
            <input type="hidden" name="class" value="<%= selectedClass %>">
            <input type="hidden" name="semester" value="<%= selectedSemester %>">
            <input type="hidden" name="branch" value="<%= selectedBranch %>">
            <input type="hidden" name="section" value="<%= selectedSection %>">
            <input type="hidden" name="subject" value="<%= selectedSubject %>"> <!-- Added hidden field for subject -->
            <table class="min-w-full mt-4 border border-gray-200">
                <thead>
                    <tr class="bg-gray-200">
                        <th class="px-4 py-2 border">#</th>
                        <th class="px-4 py-2 border">Student Name</th>
                        <th class="px-4 py-2 border">
                            <input type="checkbox" id="select-all" class="form-checkbox h-4 w-4 text-blue-600">
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <% students.forEach((student, index) => { %>
                        <tr>
                            <td class="px-4 py-2 border text-center"><%= index + 1 %></td>
                            <td class="px-4 py-2 border"><%= student.name %></td>
                            <td class="px-4 py-2 border text-center">
                                <input type="checkbox" name="attendance" value="<%= student._id %>" class="form-checkbox h-4 w-4 text-blue-600">
                            </td>
                        </tr>
                    <% }) %>
                </tbody>
            </table>
            <button type="submit"
                class="mt-4 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition duration-200">Submit Attendance</button>
        </form>
    <% }  %>
</div>

<script>
    // Select All Checkbox Functionality
    document.getElementById('select-all').addEventListener('change', function(e) {
        const checkboxes = document.querySelectorAll('input[name="attendance"]');
        checkboxes.forEach(cb => cb.checked = e.target.checked);
    });
</script>

<%- include('partials/footer') %>
